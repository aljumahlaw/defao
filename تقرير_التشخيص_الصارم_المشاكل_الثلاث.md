# ๐ ุชูุฑูุฑ ุงูุชุดุฎูุต ุงูุตุงุฑู - ุงููุดุงูู ุงูุซูุงุซ

## ๐ Section 1: Evidence (ุฃุฏูุฉ ูู ุงูููุฏ)

### A) Methods ุงููุนููุฉ - DocumentTable.php

#### 1. deleteDocument($id) - ุงูุณุทูุฑ 670-690

```php
public function deleteDocument($id)
{
    $document = Document::visibleTo(auth()->user())->findOrFail($id);  // ุงูุณุทุฑ 672

    try {
        $this->authorize('delete', $document);  // ุงูุณุทุฑ 675
    } catch (\Illuminate\Auth\Access\AuthorizationException $e) {
        $this->dispatch('show-toast', 
            message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
            type: 'error'
        );
        return;  // ุงูุณุทุฑ 681
    }

    $document->delete();  // ุงูุณุทุฑ 684

    $this->dispatch('show-toast', 
        message: 'ุชู ุญุฐู ุงููุซููุฉ ุจูุฌุงุญ', 
        type: 'success'
    );  // ุงูุณุทุฑ 686-689
}
```

**ููุงุญุธุงุช:**
- โ ูุณุชุฎุฏู `visibleTo()` ูุจู `findOrFail()` - ุงูุณุทุฑ 672
- โ ูุณุชุฎุฏู `authorize('delete')` - ุงูุณุทุฑ 675
- โ ูุณุชุฎุฏู `delete()` ูุจุงุดุฑุฉ - ุงูุณุทุฑ 684
- โ **ูุง ููุฌุฏ `$this->resetPage()` ุฃู `$this->dispatch('$refresh')` ุจุนุฏ ุงูุญุฐู**
- โ **ูุง ููุฌุฏ `wire:key` ููุตููู ูู Blade (ุงูุณุทุฑ 456) - ุณูุชู ูุญุตู ูุงุญูุงู**

---

#### 2. bulkAction() - ุงูุณุทูุฑ 424-482

```php
public function bulkAction()
{
    $this->bulkLoading = true;  // ุงูุณุทุฑ 426

    // โ ูุญุต ูุจูุฑ: ุงูุญุฐู ุงูุฌูุงุนู ูุญุฌูุฒ ููุท ููู admin
    if ($this->bulkActionValue === 'delete' && auth()->user()->role !== 'admin') {  // ุงูุณุทุฑ 429
        $this->bulkLoading = false;
        $this->dispatch('show-toast',
            message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
            type: 'error'
        );
        return;  // ุงูุณุทุฑ 437
    }

    if (empty($this->selected)) {  // ุงูุณุทุฑ 440
        // ... error
        return;
    }

    $validated = $this->validate([  // ุงูุณุทุฑ 449
        'bulkActionValue' => 'required|in:archive,delete,stage:draft,stage:review1,stage:proofread,stage:finalapproval'
    ]);

    $documentsQuery = Document::visibleTo(auth()->user())
        ->whereIn('id', $this->selected);  // ุงูุณุทูุฑ 453-454

    $count = 0;
    $errors = 0;

    try {
        match($this->bulkActionValue) {
            'archive' => $count = $documentsQuery->update(['is_archived' => true]),
            'delete' => $count = $documentsQuery->delete(),  // ุงูุณุทุฑ 462
            // ...
        };
    } catch (\Exception $e) {
        $errors = 1;
        $count = 0;  // ุงูุณุทุฑ 470
    }

    $this->bulkActionValue = '';
    $this->clearSelection();  // ุงูุณุทุฑ 474
    $this->resetPage();  // ุงูุณุทุฑ 475
    $this->bulkLoading = false;

    $this->dispatch('show-toast', 
        message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
        type: 'success'
    );  // ุงูุณุทูุฑ 478-481
}
```

**ููุงุญุธุงุช ุญุฑุฌุฉ:**
- โ๏ธ **ุงูุณุทุฑ 429:** ุงููุญุต ุงููุจูุฑ ูุนุชูุฏ ุนูู `$this->bulkActionValue === 'delete'` - ุฅุฐุง ูุงูุช ุงููููุฉ ุบูุฑ ูุญุฏุฏุฉ ุฃู ูุงุฑุบุฉ ูู ุจุฏุงูุฉ methodุ ูู ูููุน
- โ๏ธ **ุงูุณุทุฑ 462:** ูุณุชุฎุฏู `->delete()` ูุจุงุดุฑุฉ ุจุฏูู Policy check ููู ูุซููุฉ (ููู ุงูุญุงุฑุณ ูุถูู ุฃู ููุท admin ูุตู ููุง)
- โ **ุงูุณุทุฑ 470:** `$count = 0` ูู catch ููู ูุง ุฑุณุงูุฉ ุฎุทุฃ - ุงูููุฏ ุจุนุฏ catch ุฏุงุฆูุงู ูุฑุณู "ูุฌุงุญ"
- โ **ุงูุณุทุฑ 475:** `resetPage()` ููุฌูุฏ - ูุญุฏุซ refresh ูููุงุฆูุฉ

---

#### 3. bulkDelete() - ุงูุณุทูุฑ 553-591

```php
public function bulkDelete()
{
    // โ ูุญุต ูุจูุฑ: ุงูุญุฐู ุงูุฌูุงุนู ูุญุฌูุฒ ููุท ููู admin
    if (auth()->user()->role !== 'admin') {  // ุงูุณุทุฑ 556
        $this->dispatch('show-toast',
            message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
            type: 'error'
        );
        return;  // ุงูุณุทุฑ 562
    }

    $selectedIds = $this->selected;  // ุงูุณุทุฑ 566
    $deletableIds = [];

    Document::whereIn('id', $selectedIds)  // ุงูุณุทุฑ 569
        ->chunk(500, function ($documents) use (&$deletableIds) {  // ุงูุณุทุฑ 570
            foreach ($documents as $document) {
                if (auth()->user()->can('delete', $document)) {  // ุงูุณุทุฑ 572
                    $deletableIds[] = $document->id;
                }
            }
        });
    
    if (empty($deletableIds)) {  // ุงูุณุทุฑ 578
        $this->dispatch('show-toast', 
            message: 'ุบูุฑ ูุตุฑูุญ ููุฐู ุงูุนูููุฉ',
            type: 'error'
        );
        return;  // ุงูุณุทุฑ 583
    }
    
    $count = count($deletableIds);
    Document::whereIn('id', $deletableIds)->delete();  // ุงูุณุทุฑ 587
    $this->selected = [];
    $this->showBulkActions = false;
    $this->dispatch('show-toast', message: "ุชู ุญุฐู {$count} ูุณุชูุฏ ุจูุฌุงุญ", type: 'success');
}
```

**ููุงุญุธุงุช:**
- โ ุงูุญุงุฑุณ ูู ุฃูู ุงูุณุทุฑ (556) - ูููุน ุบูุฑ admin ููุฑุงู
- โ ูุณุชุฎุฏู `chunk()` + `can('delete')` ููุชุญูู ูู Policy ููู ูุซููุฉ
- โ๏ธ **ุงูุณุทุฑ 569:** ูุง ูุณุชุฎุฏู `visibleTo()` scope - ูุฏ ูุญุงูู ุญุฐู ูุซุงุฆู ุบูุฑ ูุฑุฆูุฉ
- โ **ูุง ููุฌุฏ `resetPage()` ุฃู refresh ูููุงุฆูุฉ ุจุนุฏ ุงูุญุฐู**

---

### B) Properties ุงููุฑุชุจุทุฉ - DocumentTable.php

**ุงูุณุทูุฑ 34-39:**
```php
// Bulk Actions
public array $selected = [];
public string $bulkAction = '';
public string $bulkActionValue = '';
public bool $bulkLoading = false;
public $showBulkActions = false;
```

**ุงูุณุทูุฑ 49-53:**
```php
// Email sending state
public $sendEmailModal = false;
public $tempSendEmail = '';
public $sendMessage = '';
public $selectedDocumentId;
```

**ููุงุญุธุงุช:**
- โ **ูุง ููุฌุฏ property ูุซู `$deleteId` ุฃู `$confirmDeleteId`** - ูุง state ุฎุงุต ุจุงูุญุฐู ุงููุฑุฏู
- โ `$selected` ููุฌูุฏ - ูุณุชุฎุฏู ููุชุญุฏูุฏ ุงูุฌูุงุนู
- โ `$bulkActionValue` ููุฌูุฏ - ูุณุชุฎุฏู ูุชุญุฏูุฏ ููุน ุงูุนูููุฉ ุงูุฌูุงุนูุฉ

---

### C) computed property documents() - ุงูุณุทูุฑ 77-110

```php
#[Computed]
public function documents()
{
    $query = Document::query()
        ->with(['creator:id,name', 'assignee:id,name'])
        ->visibleTo(auth()->user())  // ุงูุณุทุฑ 82
        ->when($this->type !== 'all', fn($q) => $q->where('type', $this->type))
        ->when($this->stage !== 'all', fn($q) => $q->where('current_stage', $this->stage))
        ->when($this->archived, fn($q) => $q->where('is_archived', true))
        // ...
        ->latest()
        ->paginate($this->perPage);  // ุงูุณุทุฑ 109
}
```

**ููุงุญุธุงุช:**
- โ ูุณุชุฎุฏู `#[Computed]` - Livewire v3 computed property
- โ ูุณุชุฎุฏู `visibleTo()` scope
- โ๏ธ **Computed properties ูู Livewire v3 ูุชู cache ุชููุงุฆูุงู** - ูุฏ ูุง ูุชุญุฏุซ ุจุนุฏ `delete()` ุจุฏูู refresh ุตุฑูุญ
- โ ูุณุชุฎุฏู `paginate()` - Laravel pagination

---

### D) Blade Template - ุนููุฏ ุงูุฅุฌุฑุงุกุงุช

#### Desktop Table - ุงูุณุทูุฑ 511-544

```blade
<td class="px-6 py-4">
    <div class="flex items-center gap-2">
        <a href="{{ route('documents.show', $doc->id) }}" ...>  <!-- ุงูุณุทุฑ 513-516: ุนุฑุถ - ุฏุงุฆูุงู -->
        <button wire:click="downloadDocument({{ $doc->id }})" ...>  <!-- ุงูุณุทุฑ 518-521: ุชูุฒูู - ุฏุงุฆูุงู -->
        @if($doc->current_stage !== 'finalapproval')  <!-- ุงูุณุทุฑ 523 -->
            <button wire:click='uploadNewVersion(@json($doc->id))' ...>  <!-- ุงูุณุทุฑ 524-526: ูุณุฎุฉ ุฌุฏูุฏุฉ -->
        @endif
        @if(!$doc->is_archived)  <!-- ุงูุณุทุฑ 528 -->
            <button wire:click="archiveDocument({{ $doc->id }})" ...>  <!-- ุงูุณุทุฑ 529-533: ุฃุฑุดูุฉ -->
        @endif
        <button type="button" wire:click="deleteDocument({{ $doc->id }})" onclick="return confirm('...')" ...>  <!-- ุงูุณุทุฑ 535-537: ุญุฐู - ุฏุงุฆูุงู -->
        <button wire:click="openSendEmail({{ $doc->id }})" ...>  <!-- ุงูุณุทุฑ 538-543: ุฅุฑุณุงู ุจุงูุจุฑูุฏ - ุฏุงุฆูุงู -->
    </div>
</td>
```

**ุฌุฏูู ุงูุฃุฒุฑุงุฑ Desktop:**

| ุงูุฒุฑ | ุงูุณุทุฑ | ุดุฑุท ุงูุธููุฑ | ูุนุชูุฏ ุนูู |
|------|-------|-------------|-----------|
| ุนุฑุถ | 513-516 | ุฏุงุฆูุงู | - |
| ุชูุฒูู | 518-521 | ุฏุงุฆูุงู | - |
| ูุณุฎุฉ ุฌุฏูุฏุฉ | 524-526 | `$doc->current_stage !== 'finalapproval'` | `current_stage` |
| ุฃุฑุดูุฉ | 529-533 | `!$doc->is_archived` | `is_archived` |
| ุญุฐู | 535-537 | ุฏุงุฆูุงู | - |
| ุฅุฑุณุงู ุจุงูุจุฑูุฏ | 538-543 | ุฏุงุฆูุงู | - |

**ุงูุนุฏุฏ ุงููุญุชูู:** 4-6 ุฃููููุงุช (ุญุณุจ `current_stage` ู `is_archived`)

---

#### Mobile Cards - ุงูุณุทูุฑ 616-649

```blade
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 p-2">
    <a href="{{ route('documents.show', $doc->id) }}" ...>  <!-- ุงูุณุทุฑ 617-620: ุนุฑุถ - ุฏุงุฆูุงู -->
    <x-secondary-button wire:click="downloadDocument({{ $doc->id }})" ...>  <!-- ุงูุณุทุฑ 622-625: ุชูุฒูู - ุฏุงุฆูุงู -->
    @if($doc->current_stage !== 'finalapproval')  <!-- ุงูุณุทุฑ 627 -->
        <x-secondary-button wire:click='uploadNewVersion(@json($doc->id))' ...>  <!-- ุงูุณุทุฑ 628-631: ูุณุฎุฉ ุฌุฏูุฏุฉ -->
    @endif
    @if(!$doc->is_archived)  <!-- ุงูุณุทุฑ 633 -->
        <x-secondary-button wire:click="archiveDocument({{ $doc->id }})" ...>  <!-- ุงูุณุทุฑ 634-638: ุฃุฑุดูุฉ -->
    @endif
    <x-secondary-button wire:click="deleteDocument({{ $doc->id }})" onclick="return confirm('...')" ...>  <!-- ุงูุณุทุฑ 640-644: ุญุฐู - ุฏุงุฆูุงู -->
    <x-secondary-button wire:click="openSendEmail({{ $doc->id }})" ...>  <!-- ุงูุณุทุฑ 645-649: ุฅุฑุณุงู ุจุงูุจุฑูุฏ - ุฏุงุฆูุงู -->
</div>
```

**ุฌุฏูู ุงูุฃุฒุฑุงุฑ Mobile:**

| ุงูุฒุฑ | ุงูุณุทุฑ | ุดุฑุท ุงูุธููุฑ | ูุนุชูุฏ ุนูู |
|------|-------|-------------|-----------|
| ุนุฑุถ | 617-620 | ุฏุงุฆูุงู | - |
| ุชูุฒูู | 622-625 | ุฏุงุฆูุงู | - |
| ูุณุฎุฉ ุฌุฏูุฏุฉ | 628-631 | `$doc->current_stage !== 'finalapproval'` | `current_stage` |
| ุฃุฑุดูุฉ | 634-638 | `!$doc->is_archived` | `is_archived` |
| ุญุฐู | 640-644 | ุฏุงุฆูุงู | - |
| ุฅุฑุณุงู ุจุงูุจุฑูุฏ | 645-649 | ุฏุงุฆูุงู | - |

**ุงูุนุฏุฏ ุงููุญุชูู:** 4-6 ุฃุฒุฑุงุฑ (ููุณ Desktop)

---

### E) wire:key ูู Blade

**ุงููุชูุฌุฉ:** โ **ูุง ููุฌุฏ `wire:key` ูู ุฃู ููุงู**

- ุงูุณุทุฑ 456: `@forelse($this->documents as $doc)` - **ูุง wire:key**
- ุงูุณุทุฑ 457: `<tr class="..."` - **ูุง wire:key**
- ุงูุณุทุฑ 577: `@forelse($this->documents as $doc)` (Mobile) - **ูุง wire:key**

**ุงูุขุซุงุฑ:**
- Livewire DOM diff ูุฏ ูุฑุจุท ุงูุฃุฒุฑุงุฑ ุจุตููู ุฎุงุทุฆุฉ ุจุนุฏ ุญุฐู ุตู
- ุนูุฏ ุญุฐู ูุซููุฉุ ุงูุตู ุงูุชุงูู ูุฏ "ูุฑุซ" binding ุงูุฒุฑ ุงููุญุฐูู

---

### F) Document Model - scopeVisibleTo()

**ุงูุณุทูุฑ 109-124:**
```php
public function scopeVisibleTo($query, User $user)
{
    if ($user->isAdmin()) {
        return $query;  // ุงูุณุทุฑ 112: Admin ูุฑู ูู ุดูุก
    }
    
    if ($user->isLawyer()) {
        return $query->where(function($q) use ($user) {
            $q->where('user_id', $user->id)
              ->orWhere('assignee_id', $user->id);
        });  // ุงูุณุทูุฑ 116-119
    }
    
    return $query->where('assignee_id', $user->id);  // ุงูุณุทุฑ 123: Assistant ููุท ุงููุนููุฉ ูู
}
```

**ููุงุญุธุงุช:**
- โ Admin: ูุฑู ูู ุงููุซุงุฆู (ูุง ููุงุชุฑ)
- โ Lawyer: ูุฑู ูุซุงุฆูู ุฃู ุงููุนููุฉ ูู
- โ Assistant: ูุฑู ููุท ุงููุนููุฉ ูู

---

### G) Document Model - SoftDeletes

**ุงูุณุทูุฑ 7, 11:**
```php
use Illuminate\Database\Eloquent\SoftDeletes;

class Document extends Model
{
    use HasFactory, SoftDeletes;
```

**ุงูุณุทูุฑ 28-33:**
```php
protected $casts = [
    'is_archived' => 'boolean',
    'created_at' => 'datetime',
    'updated_at' => 'datetime',
    'deleted_at' => 'datetime',  // โ SoftDeletes
];
```

**ุงููุชูุฌุฉ:** โ **Document ูุณุชุฎุฏู SoftDeletes**

**ุงูุขุซุงุฑ:**
- `delete()` ูุถุน `deleted_at` ููุท (soft delete)
- ุงููุซุงุฆู ุงููุญุฐููุฉ ุชุจูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `visibleTo()` scope **ูุง ูุณุชุซูู soft deleted** ุชููุงุฆูุงู - ูุฌุจ ุฅุถุงูุฉ `->whereNull('deleted_at')` ุตุฑุงุญุฉ ุฃู Laravel ููุนู ุฐูู ุชููุงุฆูุงู ูู queries ุนุงุฏูุฉ

---

### H) Keyboard Shortcut - JavaScript

**ุงูุณุทูุฑ 746-748:**
```javascript
// Delete: Bulk Delete
case e.key === 'Delete' && component.selected.length > 0:
    component.bulkDelete();  // โ ูุณุชุฏุนู bulkDelete()
    break;
```

**ุงููุชูุฌุฉ:** โ Keyboard shortcut ูุณุชุฏุนู `bulkDelete()` ูุจุงุดุฑุฉ

---

### I) Blade - wire:model ูููุงุฆูุฉ ุงูููุณุฏูุฉ

**ุงูุณุทุฑ 329:**
```blade
<select wire:model.live="bulkActionValue" ...>
```

**ุงูุณุทูุฑ 332-340:**
```blade
<option value="">-- ุงุฎุชุฑ ุฅุฌุฑุงุก --</option>
<option value="archive">ุฃุฑุดูุฉ</option>
<option value="delete">ุญุฐู ููุงุฆู</option>  <!-- โ ุงููููุฉ: 'delete' -->
<optgroup label="ุชุบููุฑ ุงููุฑุญูุฉ">
    <option value="stage:draft">ูุณูุฏุฉ</option>
    ...
</optgroup>
```

**ุงููุชูุฌุฉ:** โ ุงููููุฉ ุงูุตุญูุญุฉ: `'delete'` (string)

---

## ๐ Section 2: Root Cause Analysis

### ๐ด ุงููุดููุฉ 1: ุงูุญุฐู ุงููุฑุฏู ูุนูู ุฃูู ูุฑุฉ ุซู ูุชููู

#### ุงูุณุจุจ ุงูุฌุฐุฑู 1: ุนุฏู ูุฌูุฏ wire:key + DOM diff binding ุฎุงุทุฆ

**ุงูุฏููู:**
- ุงูุณุทุฑ 456 (Blade): `@forelse($this->documents as $doc)` - **ูุง wire:key**
- ุงูุณุทุฑ 457: `<tr>` - **ูุง wire:key**
- ุงูุณุทุฑ 535: `wire:click="deleteDocument({{ $doc->id }})"` - binding ูุนุชูุฏ ุนูู ููุถุน DOM

**ููู ูุคุฏู ููุณููู:**
1. ุงููุณุชุฎุฏู ูุญุฐู ูุซููุฉ ID=5 (ุงูุธูุฑ ูู ุงูุตู ุงูุฃูู)
2. `deleteDocument(5)` ูููุฐ ุจูุฌุงุญ - ุงูุณุทุฑ 684
3. ูุง ููุฌุฏ `resetPage()` ุฃู refresh - ุงููุงุฆูุฉ ูุง ุชุชุญุฏุซ ููุฑุงู
4. Livewire DOM diff ูุญุงูู "ูุทุงุจูุฉ" ุงูุตููู ุงูุฌุฏูุฏุฉ ูุน ุงููุฏููุฉ
5. ุจุฏูู `wire:key`ุ Livewire ูุฑุจุท ุงูุตู ุงูุซุงูู (ID=6) ุจุงูุตู ุงูุฃูู ุงููุฏูู (ID=5)
6. ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงูุญุฐู ูููุซููุฉ ID=6ุ Livewire ูุฑุณู `deleteDocument(5)` (ุงููููุฉ ุงููุฏููุฉ ุงููุญููุธุฉ ูู DOM binding)
7. `findOrFail(5)` ููุดู (ุงููุซููุฉ 5 ูุญุฐููุฉ) ุฃู `visibleTo()` ูุง ุชุฌุฏูุง

**ุงูููู + ุงูุณุทุฑ:**
- `document-table.blade.php:456` - `@forelse` ุจุฏูู `wire:key`
- `DocumentTable.php:684` - `delete()` ุจุฏูู `resetPage()` ุจุนุฏ ุงูุญุฐู

---

#### ุงูุณุจุจ ุงูุฌุฐุฑู 2: computed property cache + ุนุฏู refresh

**ุงูุฏููู:**
- ุงูุณุทุฑ 77-110: `#[Computed] public function documents()` - Livewire v3 computed cache
- ุงูุณุทุฑ 684: `$document->delete()` - ูุง refresh ููู computed

**ููู ูุคุฏู ููุณููู:**
1. `documents()` computed ูุชู cache ูู Livewire v3
2. ุนูุฏ `delete()`ุ ุงููุซููุฉ ุชูุญุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. ููู `documents()` computed ูุง ูุชุญุฏุซ ุชููุงุฆูุงู (cache)
4. ุงููุซููุฉ ุชุจูู ูู ุงููุงุฌูุฉ ุฑุบู ุญุฐููุง
5. ุนูุฏ ุงูุถุบุท ุนูู ููุณ ุงููุซููุฉ ูุฑุฉ ุซุงููุฉุ `findOrFail()` ูุฏ ูุฌุฏูุง (soft delete) ุฃู ูุง (ุญุณุจ timing)

**ุงูููู + ุงูุณุทุฑ:**
- `DocumentTable.php:77` - `#[Computed]` cache
- `DocumentTable.php:684` - ูุง `$this->resetPage()` ุจุนุฏ delete

---

#### ุงูุณุจุจ ุงูุฌุฐุฑู 3: visibleTo() + SoftDeletes ูุฏ ูุง ูุณุชุซูู deleted_at ุชููุงุฆูุงู

**ุงูุฏููู:**
- `Document.php:11` - `use SoftDeletes`
- `Document.php:109-124` - `scopeVisibleTo()` ูุง ูุณุชุซูู `deleted_at` ุตุฑุงุญุฉ
- Laravel Eloquent ูุณุชุซูู soft deleted ุชููุงุฆูุงู ูู queries ุนุงุฏูุฉุ ููู ูู scopes ูุฎุตุตุฉ ูุฏ ูุญุชุงุฌ ูุญุต ุตุฑูุญ

**ููู ูุคุฏู ููุณููู:**
- ุจุนุฏ soft deleteุ `visibleTo()->findOrFail()` ูุฏ ูุง ุชุฌุฏ ุงููุซููุฉ (Laravel ูุณุชุซูู soft deleted ุชููุงุฆูุงู)
- ุฃู ูุฏ ุชุฌุฏูุง ุฅุฐุง ูุงู scope ูุถูู conditions ูุจู Laravel soft delete check

**ุงูููู + ุงูุณุทุฑ:**
- `Document.php:109` - `scopeVisibleTo()` ูุฏ ูุง ูุชุนุงูู ุจุดูู ุตุญูุญ ูุน soft deleted

---

### ๐ด ุงููุดููุฉ 2: ุงูุญุฐู ุงูุฌูุงุนู ูุง ูุญุฐู ุฑุบู admin

#### ุงูุณุจุจ ุงูุฌุฐุฑู 1: bulkAction() - catch block ูุฎูู ุงูุฎุทุฃ

**ุงูุฏููู:**
- ุงูุณุทุฑ 462: `'delete' => $count = $documentsQuery->delete()`
- ุงูุณุทูุฑ 468-471: catch block ูุถุน `$count = 0` ููู ูุง ูุฑุณู ุฑุณุงูุฉ ุฎุทุฃ
- ุงูุณุทูุฑ 478-481: ุฏุงุฆูุงู ูุฑุณู "ูุฌุงุญ" ุญุชู ูู `$count = 0`

**ููู ูุคุฏู ููุณููู:**
1. Admin ูุฎุชุงุฑ "ุญุฐู ููุงุฆู" + ูุถุบุท "ุชูููุฐ"
2. `bulkAction()` ุชุตู ุฅูู ุงูุณุทุฑ 462
3. `$documentsQuery->delete()` ูุฏ ููุดู (Foreign Key constraint, Exception ุขุฎุฑ)
4. catch block ููุชูุท Exception โ `$count = 0`
5. ุงูููุฏ ุจุนุฏ catch ุฏุงุฆูุงู ูุฑุณู "ุชูุช ุงูุนูููุฉ ุนูู 0 ูุซููุฉ ุจูุฌุงุญ"
6. ุงููุณุชุฎุฏู ูุง ูุนุฑู ุฃู ุงูุญุฐู ูุดู

**ุงูููู + ุงูุณุทุฑ:**
- `DocumentTable.php:468-471` - catch block ูุฎูู ุงูุฎุทุฃ
- `DocumentTable.php:478-481` - ุฑุณุงูุฉ ูุฌุงุญ ุฏุงุฆูุงู

---

#### ุงูุณุจุจ ุงูุฌุฐุฑู 2: bulkDelete() - ูุง ูุณุชุฎุฏู visibleTo() scope

**ุงูุฏููู:**
- ุงูุณุทุฑ 569: `Document::whereIn('id', $selectedIds)` - **ูุง visibleTo()**
- ุงูุณุทุฑ 570-576: `chunk()` + `can('delete')` - Policy check ููู ูุง scope filter

**ููู ูุคุฏู ููุณููู:**
1. Admin ูุญุฏุฏ ูุซุงุฆู ID [1, 2, 3]
2. `bulkDelete()` ุชุณุชุฏุนู `Document::whereIn('id', [1,2,3])->chunk()`
3. ููู ุฅุฐุง ูุงูุช ุงููุซููุฉ 2 ูุซูุงู ูุญุฐููุฉ (soft delete) ุฃู ุบูุฑ ูุฑุฆูุฉุ `chunk()` ูุฏ ูุง ุชุฌุฏูุง
4. `$deletableIds` ูุฏ ุชููู ูุงุฑุบุฉ ุฃู ูุงูุตุฉ
5. ุฃู ูุฏ ุชุญุงูู ุญุฐู ูุซุงุฆู ุบูุฑ ููุฌูุฏุฉ ูู query

**ุงูููู + ุงูุณุทุฑ:**
- `DocumentTable.php:569` - ูุง `visibleTo()` scope

---

#### ุงูุณุจุจ ุงูุฌุฐุฑู 3: bulkAction() - ุงููุญุต ุงููุจูุฑ ูุนุชูุฏ ุนูู bulkActionValue ูุจู validation

**ุงูุฏููู:**
- ุงูุณุทุฑ 429: `if ($this->bulkActionValue === 'delete' && ...)`
- ุงูุณุทุฑ 449: `$validated = $this->validate([...])` - validation ุจุนุฏ ุงููุญุต

**ููู ูุคุฏู ููุณููู:**
- ุฅุฐุง ูุงูุช `$this->bulkActionValue` ูุงุฑุบุฉ ุฃู ุบูุฑ ูุญุฏุฏุฉ ูู ุจุฏุงูุฉ method (edge case)ุ ุงููุญุต ุงููุจูุฑ ูู ูููุน
- ููู ูุฐุง unlikely ูุฃู `wire:model.live` ูุถูู ุงููููุฉ ููุฌูุฏุฉ

**ุงูููู + ุงูุณุทุฑ:**
- `DocumentTable.php:429` - ูุญุต ูุจูุฑ ูุจู validation (ููู unlikely ูุดููุฉ)

---

### ๐ด ุงููุดููุฉ 3: ุชูุงูุช ุนุฏุฏ ุงูุฃููููุงุช

#### ุงูุณุจุจ ุงูุฌุฐุฑู: ุงูุดุฑูุท ุงูุดุฑุทูุฉ ูู Blade

**ุงูุฏููู ูู ุงูุฌุฏูู ุฃุนูุงู:**

**Desktop (ุงูุณุทูุฑ 523-534):**
- ุฒุฑ "ูุณุฎุฉ ุฌุฏูุฏุฉ": `@if($doc->current_stage !== 'finalapproval')` - ุงูุณุทุฑ 523
- ุฒุฑ "ุฃุฑุดูุฉ": `@if(!$doc->is_archived)` - ุงูุณุทุฑ 528

**Mobile (ุงูุณุทูุฑ 627-639):**
- ููุณ ุงูุดุฑูุท

**ุงููุชูุฌุฉ:**
- ุฅุฐุง `current_stage === 'finalapproval'`: 5 ุฃููููุงุช (ุจุฏูู "ูุณุฎุฉ ุฌุฏูุฏุฉ")
- ุฅุฐุง `is_archived === true`: 5 ุฃููููุงุช (ุจุฏูู "ุฃุฑุดูุฉ")
- ุฅุฐุง ูููููุง: 4 ุฃููููุงุช (ุจุฏูู "ูุณุฎุฉ ุฌุฏูุฏุฉ" ู "ุฃุฑุดูุฉ")
- ุนุงุฏุฉ: 6 ุฃููููุงุช

**ุงูููู + ุงูุณุทุฑ:**
- `document-table.blade.php:523` - ุดุฑุท `current_stage`
- `document-table.blade.php:528` - ุดุฑุท `is_archived`

**ูู ูู ุนูุงูุฉ ุจูุดุงูู ุงูุญุฐูุ**
- โ ูุง - ูุฐู ูุดููุฉ UI ููุท (ุชูุงูุช ุนุฏุฏ ุงูุฃููููุงุช ุญุณุจ ุญุงูุฉ ุงููุซููุฉ)
- โ ููู ูููู ุฃู ุชุณุจุจ confusion ูููุณุชุฎุฏู (ุฃููููุงุช ุชุธูุฑ/ุชุฎุชูู)

---

## ๐ Section 3: Minimal Fix Diffs

### Fix 1: ุงูุญุฐู ุงููุฑุฏู - ุฅุถุงูุฉ wire:key + resetPage()

**ุงูููู:** `resources/views/livewire/documents/document-table.blade.php`

**ุงูุณุทุฑ 456-457:**
```diff
- @forelse($this->documents as $doc)
-     <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50" @class(['bg-primary/5 dark:bg-primary/10' => in_array($doc->id, $this->selected)])>
+ @forelse($this->documents as $doc)
+     <tr wire:key="document-{{ $doc->id }}" class="hover:bg-gray-50 dark:hover:bg-gray-700/50" @class(['bg-primary/5 dark:bg-primary/10' => in_array($doc->id, $this->selected)])>
```

**ุงูุณุทุฑ 577 (Mobile):**
```diff
- @forelse($this->documents as $doc)
-     <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4" @class(['ring-2 ring-primary' => in_array($doc->id, $this->selected)])>
+ @forelse($this->documents as $doc)
+     <div wire:key="document-mobile-{{ $doc->id }}" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4" @class(['ring-2 ring-primary' => in_array($doc->id, $this->selected)])>
```

**ุงูููู:** `app/Livewire/Documents/DocumentTable.php`

**ุงูุณุทูุฑ 684-689:**
```diff
    $document->delete();

+   $this->resetPage();  // โ Refresh computed property cache

    $this->dispatch('show-toast', 
        message: 'ุชู ุญุฐู ุงููุซููุฉ ุจูุฌุงุญ', 
        type: 'success'
    );
```

---

### Fix 2: ุงูุญุฐู ุงูุฌูุงุนู - ุฅุตูุงุญ error handling ูู bulkAction()

**ุงูููู:** `app/Livewire/Documents/DocumentTable.php`

**ุงูุณุทูุฑ 468-481:**
```diff
    } catch (\Exception $e) {
-       $errors = 1;
-       $count = 0;
+       \Log::error('Bulk action failed: ' . $e->getMessage(), [
+           'action' => $this->bulkActionValue,
+           'selected' => $this->selected,
+           'user_id' => auth()->id(),
+       ]);
+       $this->bulkActionValue = '';
+       $this->bulkLoading = false;
+       $this->dispatch('show-toast',
+           message: 'ูุดูุช ุงูุนูููุฉ: ' . $e->getMessage(),
+           type: 'error'
+       );
+       return;  // โ Exit early on error
    }

-   $this->bulkActionValue = '';
-   $this->clearSelection();
-   $this->resetPage();
-   $this->bulkLoading = false;
-
-   $this->dispatch('show-toast', 
-       message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
-       type: 'success'
-   );
+   // โ Only execute if no exception
+   if ($count > 0) {
+       $this->bulkActionValue = '';
+       $this->clearSelection();
+       $this->resetPage();
+       $this->bulkLoading = false;
+       $this->dispatch('show-toast', 
+           message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
+           type: 'success'
+       );
+   } else {
+       $this->bulkActionValue = '';
+       $this->bulkLoading = false;
+       $this->dispatch('show-toast',
+           message: 'ูู ูุชู ุญุฐู ุฃู ูุซุงุฆู. ุชุญูู ูู ุงูุตูุงุญูุงุช ุฃู ุงูุงุชุตุงูุงุช.',
+           type: 'warning'
+       );
+   }
```

---

### Fix 3: bulkDelete() - ุฅุถุงูุฉ visibleTo() scope

**ุงูููู:** `app/Livewire/Documents/DocumentTable.php`

**ุงูุณุทุฑ 569:**
```diff
-   Document::whereIn('id', $selectedIds)
+   Document::visibleTo(auth()->user())
+       ->whereIn('id', $selectedIds)
        ->chunk(500, function ($documents) use (&$deletableIds) {
```

**ุงูุณุทุฑ 587:**
```diff
-   Document::whereIn('id', $deletableIds)->delete();
+   Document::visibleTo(auth()->user())
+       ->whereIn('id', $deletableIds)
+       ->delete();
```

---

## ๐ Section 4: Verification Steps

### Test 1: ุงูุญุฐู ุงููุฑุฏู ูุนูู ูู ูุฑุฉ

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุตูุญุฉ `/documents` ูู admin
2. ุงุญุฐู ุงููุซููุฉ ุงูุฃููู (ุงุถุบุท ุฒุฑ ุงูุญุฐู ๐๏ธ + confirm)
3. **ุงูุชุญูู:** ุงููุซููุฉ ุชุฎุชูู ูู ุงููุงุฆูุฉ ููุฑุงู
4. ุงุญุฐู ุงููุซููุฉ ุงูุซุงููุฉ (ุงูุขู ุฃุตุจุญุช ุงูุฃููู)
5. **ุงูุชุญูู:** ุงููุซููุฉ ุงูุซุงููุฉ ุชูุญุฐู ุจูุฌุงุญ (ูุง ูุชููู)
6. ูุฑุฑ 5-10 ูุฑุงุช
7. **ุงูุชุญูู:** ูู ุญุฐู ูุนูู ุจุดูู ูุณุชูู

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูู ุญุฐู ูุนูู
- โ ุงููุงุฆูุฉ ุชุชุญุฏุซ ููุฑุงู
- โ ูุง ุฃุฎุทุงุก ูู console

---

### Test 2: ุงูุญุฐู ุงูุฌูุงุนู ูุนูู ููู admin

**ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุตูุญุฉ `/documents` ูู admin
2. ุญุฏุฏ 3 ูุซุงุฆู (checkboxes)
3. ุงุฎุชุฑ "ุญุฐู ููุงุฆู" ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
4. ุงุถุบุท "ุชูููุฐ"
5. **ุงูุชุญูู:** ุชุธูุฑ ุฑุณุงูุฉ "ุชูุช ุงูุนูููุฉ ุนูู 3 ูุซุงุฆู ุจูุฌุงุญ"
6. **ุงูุชุญูู:** ุงููุซุงุฆู ุงูุซูุงุซ ุชุฎุชูู ูู ุงููุงุฆูุฉ
7. **ุงูุชุญูู:** ูุง ุฃุฎุทุงุก ูู console ุฃู logs

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ุงูุญุฐู ูุนูู
- โ ุฑุณุงูุฉ ูุฌุงุญ ูุงุถุญุฉ
- โ ุงููุงุฆูุฉ ุชุชุญุฏุซ

---

### Test 3: ุงูุญุฐู ุงูุฌูุงุนู ูู Dropdown

**ุงูุฎุทูุงุช:**
1. ุญุฏุฏ 2 ูุซุงุฆู
2. ุงุถุบุท "ุฅุฌุฑุงุกุงุช ุฌูุงุนูุฉ"
3. ุงุถุบุท "๐๏ธ ุญุฐู ููุงุฆู"
4. **ุงูุชุญูู:** ุชุธูุฑ ุฑุณุงูุฉ "ุชู ุญุฐู 2 ูุณุชูุฏ ุจูุฌุงุญ"
5. **ุงูุชุญูู:** ุงููุซุงุฆู ุชุฎุชูู

---

### Test 4: ุชูุงูุช ุงูุฃููููุงุช (UI ููุท)

**ุงูุชุญูู ุงููุฏูู:**
1. ุงูุชุญ ุตูุญุฉ `/documents`
2. ุงูุญุต ูู ุตู ูู ุงูุฌุฏูู
3. **ุงูุชุญูู:** ุนุฏุฏ ุงูุฃููููุงุช ูุฎุชูู ุญุณุจ:
   - `current_stage === 'finalapproval'` โ 5 ุฃููููุงุช (ุจุฏูู "ูุณุฎุฉ ุฌุฏูุฏุฉ")
   - `is_archived === true` โ 5 ุฃููููุงุช (ุจุฏูู "ุฃุฑุดูุฉ")
   - ุนุงุฏู โ 6 ุฃููููุงุช

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุฐุง ุณููู ูุชููุน (ููุณ bug)
- โ ูููู ุชุญุณููู ูุงุญูุงู ุฅุฐุง ูุงู ูุทููุจุงู

---

## ๐ Section 5: Root Causes of Analysis Failure (ุณุงุจูุงู)

### 1. ุนุฏู ูุฑุงุกุฉ Blade template ุจุงููุงูู
- **ุงููุดู:** ุงูุชุฑููุฒ ุนูู PHP ููุทุ ุชุฌุงูู DOM binding issues
- **ุงูุญู:** ูุฑุงุกุฉ Blade ูุงููุฉ ูุน ูุญุต `wire:key`, `wire:click`, conditions

### 2. ุชุฌุงูู SoftDeletes + visibleTo() interaction
- **ุงููุดู:** ุงูุชุฑุงุถ ุฃู `visibleTo()` ูุชุนุงูู ูุน soft deleted ุชููุงุฆูุงู
- **ุงูุญู:** ูุญุต Document Model + scopeVisibleTo() ุจุฏูุฉ

### 3. ุชุฌุงูู Livewire v3 computed property caching
- **ุงููุดู:** ุงูุชุฑุงุถ ุฃู computed properties ุชุชุญุฏุซ ุชููุงุฆูุงู ุจุนุฏ mutations
- **ุงูุญู:** ุฅุถุงูุฉ `resetPage()` ุฃู `$refresh` ุจุนุฏ delete

### 4. ุนุฏู ุชุชุจุน ูุณุงุฑ ุงูุชูููุฐ ุงููุงูู
- **ุงููุดู:** ุชุญููู methods ูููุตูุฉ ุจุฏูู ุฑุจุท ุจุงูู UI
- **ุงูุญู:** ุชุชุจุน ุงููุณุงุฑ ูู Blade โ Livewire โ Model โ Database

---

## ๐ Section 6: Model Information

**ุงูููุฏูู ุงููุณุชุฎุฏู:** ูุง ูููู ุงูุชุญูู ูู ุงูููุฏูู ูู ุฏุงุฎู Cursor (ูุง ูุนูููุงุช ูุชุงุญุฉ ูู UI)

**ุงูุชุฑุงุญ ููุฏูู ุฃูุถู:**
- **Claude Sonnet 4.5** ุฃู **GPT-4 Turbo** - ููู context length ุงููุจูุฑ (ูุฐุง ุงูุชูุฑูุฑ ุทููู)
- **Gemini Pro** - ููู code reasoning ุงูุฌูุฏ
- **ุฃู ุฃู ููุฏูู ุจู 200K+ context** - ููุฑุงุกุฉ ูููุงุช ูุจูุฑุฉ ูุงููุฉ

**ุงูุณุจุจ:**
- ูุฐู ุงููููุฉ ุชุชุทูุจ ูุฑุงุกุฉ ูููุงุช ูุจูุฑุฉ (DocumentTable.php 698 ุณุทุฑุ Blade 840 ุณุทุฑ)
- ุชุญููู ูุชุนูู ููููุฏ ูุน ุฑุจุท ุจูู ูููุงุช ูุชุนุฏุฏุฉ
- Context length ูุจูุฑ ูุทููุจ

---

**ุชู ุงูุชุดุฎูุต ุงูุตุงุฑู ุจุฏูู ุชุนุฏููุงุช โ**


