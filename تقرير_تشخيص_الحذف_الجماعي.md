# ๐ ุชูุฑูุฑ ุงูุชุดุฎูุต - ูุดููุฉ ุงูุญุฐู ุงูุฌูุงุนู ูููุซุงุฆู

## 1๏ธโฃ ุชุญุฏูุฏ ููุทู ุงูุญุฐู ุงูุฌูุงุนู

### ุงููููุงุช ุงููุนููุฉ:

**ุงูููู ุงูุฑุฆูุณู:**
- `app/Livewire/Documents/DocumentTable.php`

**Blade Template:**
- `resources/views/livewire/documents/document-table.blade.php`

---

## 2๏ธโฃ ุงูุฎุตุงุฆุต ูุงูู Methods ูู DocumentTable.php

### ุงูุฎุตุงุฆุต (Properties) ุงููุฑุชุจุทุฉ ุจุงูุญุฐู ุงูุฌูุงุนู:

```php
// Bulk Actions
public array $selected = [];           // IDs ุงููุซุงุฆู ุงููุญุฏุฏุฉ
public string $bulkAction = '';        // ุบูุฑ ูุณุชุฎุฏู ุญุงููุงู
public string $bulkActionValue = '';   // ุงููููุฉ ุงููุฎุชุงุฑุฉ ูู ุงููุงุฆูุฉ: 'archive', 'delete', 'stage:*'
public bool $bulkLoading = false;      // ุญุงูุฉ ุงูุชุญููู
public $showBulkActions = false;       // ุฅุธูุงุฑ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
```

**ุงููููุน:** ุงูุณุทูุฑ 35-39 ูู `DocumentTable.php`

---

### Methods ุงููุนููุฉ ุจุงูุญุฐู ุงูุฌูุงุนู:

#### 1) `bulkAction()` - Method ุงูุฑุฆูุณู ููุญุฐู ุงูุฌูุงุนู

**ุงููููุน:** ุงูุณุทูุฑ 424-468 ูู `DocumentTable.php`

**ุงูููุฏ ุงููุงูู:**
```php
public function bulkAction()
{
    $this->bulkLoading = true;

    if (empty($this->selected)) {
        $this->bulkLoading = false;
        $this->dispatch('show-toast', 
            message: 'ูู ูุชู ุชุญุฏูุฏ ุฃู ูุซุงุฆู',
            type: 'error'
        );
        return;
    }

    $validated = $this->validate([
        'bulkActionValue' => 'required|in:archive,delete,stage:draft,stage:review1,stage:proofread,stage:finalapproval'
    ]);

    $documentsQuery = Document::visibleTo(auth()->user())
        ->whereIn('id', $this->selected);

    $count = 0;
    $errors = 0;

    try {
        match($this->bulkActionValue) {
            'archive' => $count = $documentsQuery->update(['is_archived' => true]),
            'delete' => $count = $documentsQuery->delete(),  // โ๏ธ ููุง ุงููุดููุฉ
            'stage:draft' => $count = $documentsQuery->update(['current_stage' => 'draft']),
            'stage:review1' => $count = $documentsQuery->update(['current_stage' => 'review1']),
            'stage:proofread' => $count = $documentsQuery->update(['current_stage' => 'proofread']),
            'stage:finalapproval' => $count = $documentsQuery->update(['current_stage' => 'finalapproval']),
        };
    } catch (\Exception $e) {
        $errors = 1;
        $count = 0;
    }

    $this->bulkActionValue = '';
    $this->clearSelection();
    $this->resetPage();
    $this->bulkLoading = false;

    $this->dispatch('show-toast', 
        message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
        type: 'success'
    );
}
```

**ูุง ุงูุฐู ุชูุนูู:**
- โ ุชุชุญูู ูู ูุฌูุฏ ูุซุงุฆู ูุญุฏุฏุฉ
- โ ุชุชุญูู ูู ุตุญุฉ `bulkActionValue` (ูุฌุจ ุฃู ุชููู: `'delete'`, `'archive'`, ุฃู `'stage:*'`)
- โ ุชุณุชุฎุฏู `Document::visibleTo()` scope ูุชุตููุฉ ุงููุซุงุฆู ุงููุฑุฆูุฉ ูููุณุชุฎุฏู
- โ **ูุง ุชุชุญูู ูู Policy (`$this->authorize('delete', $document)`) ูุจู ุงูุญุฐู**
- โ **ูุง ุชุชุญูู ูู `$count` ุจุนุฏ try/catch - ุชุฑุณู ุฑุณุงูุฉ ูุฌุงุญ ุญุชู ูู ูุงู `$count = 0`**
- โ๏ธ ุชุณุชุฎุฏู `whereIn()->delete()` ูุจุงุดุฑุฉ (ูุฏ ููุดู ุจุณุจุจ Foreign Key constraints)

---

#### 2) `bulkDelete()` - Method ูููุตูุฉ (ุบูุฑ ูุณุชุฎุฏูุฉ ูู Toolbar)

**ุงููููุน:** ุงูุณุทูุฑ 541-566 ูู `DocumentTable.php`

**ุงูููุฏ ุงููุงูู:**
```php
public function bulkDelete()
{
    // โ P1-8: Policy check ูุน chunking ููุฃุฏุงุก
    $selectedIds = $this->selected;
    $deletableIds = [];

    Document::whereIn('id', $selectedIds)
        ->chunk(500, function ($documents) use (&$deletableIds) {
            foreach ($documents as $document) {
                if (auth()->user()->can('delete', $document)) {
                    $deletableIds[] = $document->id;
                }
            }
        });
    
    if (empty($deletableIds)) {
        $this->dispatch('show-toast', 
            message: 'ุบูุฑ ูุตุฑูุญ ููุฐู ุงูุนูููุฉ',
            type: 'error'
        );
        return;
    }
    
    $count = count($deletableIds);
    Document::whereIn('id', $deletableIds)->delete();
    $this->selected = [];
    $this->showBulkActions = false;
    $this->dispatch('show-toast', message: "ุชู ุญุฐู {$count} ูุณุชูุฏ ุจูุฌุงุญ", type: 'success');
}
```

**ุงููุฑู ุงูุฑุฆูุณู:**
- โ `bulkDelete()` **ุชุชุญูู ูู Policy** ููู ูุซููุฉ ูุจู ุงูุญุฐู
- โ `bulkAction()` **ูุง ุชุชุญูู ูู Policy** - ุชุณุชุฎุฏู ููุท `visibleTo()` scope

**โ๏ธ ููุงุญุธุฉ ูููุฉ:** `bulkDelete()` ููุฌูุฏุฉ ููู **ูุง ูุชู ุงุณุชุฏุนุงุคูุง** ูู Toolbar - ููุท ูู Dropdown menu (ุงูุณุทุฑ 94 ูู Blade)

---

#### 3) `deleteDocument($id)` - ุงูุญุฐู ุงููุฑุฏู (ููููุงุฑูุฉ)

**ุงููููุน:** ุงูุณุทูุฑ 648-657 ูู `DocumentTable.php`

```php
public function deleteDocument($id)
{
    $document = Document::findOrFail($id);
    $this->authorize('delete', $document);  // โ Policy check

    $document->delete();

    session()->flash('message', 'ุชู ุญุฐู ุงููุซููุฉ ุจูุฌุงุญ');
    $this->clearSelection();
}
```

**ุงูููุงุฑูุฉ:**
- โ `deleteDocument()` ูุณุชุฎุฏู `$this->authorize('delete', $document)` ูุจู ุงูุญุฐู
- โ `bulkAction()` **ูุง ูุณุชุฎุฏู authorize** - ูุนุชูุฏ ููุท ุนูู `visibleTo()` scope

---

## 3๏ธโฃ ุชุญููู Blade Template

### ุดุฑูุท "ุชู ุชุญุฏูุฏ X ูุซููุฉ" ูุฒุฑ "ุชูููุฐ"

**ุงููููุน:** ุงูุณุทูุฑ 316-390 ูู `document-table.blade.php`

**ุงูููุฏ ุงูุฃุณุงุณู:**
```blade
@if(count($this->selected) > 0)
    <div class="...">
        <div>ุชู ุชุญุฏูุฏ {{ count($this->selected) }} ูุซููุฉ</div>
        
        <select wire:model.live="bulkActionValue">
            <option value="">-- ุงุฎุชุฑ ุฅุฌุฑุงุก --</option>
            <option value="archive">ุฃุฑุดูุฉ</option>
            <option value="delete">ุญุฐู ููุงุฆู</option>  <!-- โ๏ธ ุงููููุฉ: 'delete' -->
            <optgroup label="ุชุบููุฑ ุงููุฑุญูุฉ">
                <option value="stage:draft">ูุณูุฏุฉ</option>
                ...
            </optgroup>
        </select>

        <button wire:click="bulkAction">  <!-- โ ูุณุชุฏุนู bulkAction() -->
            ุชูููุฐ
        </button>
    </div>
@endif
```

**ูุณุงุฑ ุงูุฃุญุฏุงุซ:**
1. ุงููุณุชุฎุฏู ูุญุฏุฏ 20 ูุซููุฉ โ `$this->selected = [1, 2, 3, ..., 20]`
2. ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ุญุฐู ููุงุฆู" ูู ุงููุงุฆูุฉ โ `$this->bulkActionValue = 'delete'`
3. ุงููุณุชุฎุฏู ูุถุบุท "ุชูููุฐ" โ `wire:click="bulkAction"` ูุณุชุฏุนู `bulkAction()` method
4. `bulkAction()` method ุชููุฐ ุงูููุฏ ูู ุงูุณุทูุฑ 424-468

**ุงููููุฉ ุงููุฑุณูุฉ:** `bulkActionValue = 'delete'` โ (ุชุทุงุจู ูุน validation rule)

---

## 4๏ธโฃ ุชุญููู ุงูุณุจุจ ุงููุญุชูู

### ๐จ ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:

**`bulkAction()` ูุง ุชุชุญูู ูู Policy ูุจู ุงูุญุฐูุ ูุชุฑุณู ุฑุณุงูุฉ ูุฌุงุญ ุญุชู ูู ูุดู ุงูุญุฐู**

### ุงูุฃุณุจุงุจ ุงููุญุชููุฉ ุจุงูุชูุตูู:

#### ุงูุณุจุจ 1: ุนุฏู ุงูุชุญูู ูู Policy (ุงูุฃูุซุฑ ุงุญุชูุงูุงู)

```php
// bulkAction() - ุงูุณุทุฑ 441-450
$documentsQuery = Document::visibleTo(auth()->user())
    ->whereIn('id', $this->selected);

match($this->bulkActionValue) {
    'delete' => $count = $documentsQuery->delete(),  // โ ูุง Policy check
};
```

**ุงููุดููุฉ:**
- `visibleTo()` scope ูุชุญูู ููุท ูู **ุงูุฑุคูุฉ** (visibility)ุ ูููุณ ูู **ุงูุตูุงุญูุฉ** (permission)
- DocumentPolicy@delete ูููุน ุงููุณุงุนุฏูู ูู ุงูุญุฐูุ ููุณูุญ ููุท ูููุฏูุฑ ุฃู ูุงูู ุงููุซููุฉ
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุงุนุฏุ ุฃู ุญุงูู ุญุฐู ูุซููุฉ ูุง ูููููุงุ Laravel **ูุฏ ูุง ูุฑูู exception** ุนูุฏ ุงุณุชุฎุฏุงู `whereIn()->delete()`
- ุงููุชูุฌุฉ: `$count` ูุฏ ูููู 0 (ูุง ูุซุงุฆู ูุญุฐููุฉ)ุ ููู ูุง ุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ

---

#### ุงูุณุจุจ 2: Foreign Key Constraints (ูุญุชูู)

```php
// Document Model uses SoftDeletes
// Document may have relationships:
// - hasMany(Task::class)
// - hasMany(DocumentTask::class)
// - hasMany(DocumentActivity::class)
```

**ุงููุดููุฉ:**
- ุฅุฐุง ูุงู ููุงู Foreign Key constraints ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุซูุงู: `tasks.document_id` โ `documents.id`)
- ูุจูุง ุฃู Document ูุณุชุฎุฏู SoftDeletesุ ุงูุญุฐู ุณูููู soft delete (ูุง ุญุฐู ูุนูู)
- ููู ุฅุฐุง ูุงู ููุงู constraint ุจู `ON DELETE RESTRICT`ุ ูุฏ ููุดู ุงูุญุฐู
- Exception ุณูุชู ุงูุชูุงุทู ูู catch blockุ ููู ูุง ุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู

---

#### ุงูุณุจุจ 3: try/catch ูุฎูู ุงูุฃุฎุทุงุก ุจุฏูู ุฑุณุงูุฉ

```php
try {
    match($this->bulkActionValue) {
        'delete' => $count = $documentsQuery->delete(),
    };
} catch (\Exception $e) {
    $errors = 1;  // โ ูุชู ุชุนููู errors ููู ูุง ูุณุชุฎุฏู
    $count = 0;
}

// ุจุนุฏ catch - ุฏุงุฆูุงู ูุฑุณู ุฑุณุงูุฉ ูุฌุงุญ
$this->dispatch('show-toast', 
    message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",  // โ ุญุชู ูู count = 0
    type: 'success'
);
```

**ุงููุดููุฉ:**
- ุฅุฐุง ูุดู ุงูุญุฐู (Exception)ุ `$count` ูุจูู 0
- ููู ุงูููุฏ ุจุนุฏ catch **ุฏุงุฆูุงู ูุฑุณู ุฑุณุงูุฉ ูุฌุงุญ** ุญุชู ูู ูุงู `$count = 0`
- ุงููุณุชุฎุฏู ูุฑู: "ุชูุช ุงูุนูููุฉ ุนูู 0 ูุซููุฉ ุจูุฌุงุญ" (ุฑุณุงูุฉ ูุถููุฉ)
- ูุง ุชูุฌุฏ ุฑุณุงูุฉ ุฎุทุฃ ุชูุถุญ ุณุจุจ ุงููุดู

---

#### ุงูุณุจุจ 4: clearSelection() ูุชู ุงุณุชุฏุนุงุคู ุฏุงุฆูุงู

```php
$this->clearSelection();  // โ ูุชู ุงุณุชุฏุนุงุคู ุญุชู ูู ูุดู ุงูุญุฐู
$this->resetPage();
$this->bulkLoading = false;

$this->dispatch('show-toast', 
    message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
    type: 'success'
);
```

**ุงููุดููุฉ:**
- ุญุชู ูู ูุงู `$count = 0` (ูุดู ุงูุญุฐู)ุ `clearSelection()` ูุชู ุงุณุชุฏุนุงุคู
- `$this->selected` ูุชู ูุณุญูุ ููุฎุชูู ุดุฑูุท "ุชู ุชุญุฏูุฏ X ูุซููุฉ"
- ุงููุณุชุฎุฏู ูุธู ุฃู ุงูุนูููุฉ ูุฌุญุช ูุฃู ุงููุงุฌูุฉ ุชุบูุฑุช

---

## 5๏ธโฃ ุงูุงุณุชูุชุงุฌ ุงูุชููู

### ๐ฏ ุงูุณุจุจ ุงููุญุชูู ุงูุฑุฆูุณู:

**`bulkAction()` ูุง ุชุชุญูู ูู Policy ูุจู ุงูุญุฐูุ ููุง ุชุชุญูู ูู `$count` ุจุนุฏ try/catchุ ููุง ูุคุฏู ุฅูู:**

1. **ุนุฏู ุญุฐู ุงููุซุงุฆู** ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุง ูููู ุตูุงุญูุฉ ุงูุญุฐู (ูุซูุงู: ูุณุงุนุฏ ูุญุงูู ุญุฐู ูุซููุฉ)
2. **ุนุฏู ุญุฐู ุงููุซุงุฆู** ุฅุฐุง ูุงู ููุงู Foreign Key constraint ูููุน ุงูุญุฐู
3. **ุฅุฑุณุงู ุฑุณุงูุฉ ูุฌุงุญ ูุถููุฉ** ุญุชู ูู ูุงู `$count = 0`
4. **ูุณุญ `$selected`** ุญุชู ูู ูุดู ุงูุญุฐูุ ููุง ูุฌุนู ุงููุณุชุฎุฏู ูุธู ุฃู ุงูุนูููุฉ ูุฌุญุช

### ๐ ููุงุฑูุฉ ูุน ุงูุญุฐู ุงููุฑุฏู:

| ุงูููุฒุฉ | `deleteDocument()` (ูุฑุฏู) | `bulkAction()` (ุฌูุงุนู) |
|--------|---------------------------|------------------------|
| Policy Check | โ `$this->authorize('delete', $document)` | โ ูุง ููุฌุฏ |
| Error Handling | โ Exception ูุธูุฑ ูููุณุชุฎุฏู | โ Exception ูุชู ุฅุฎูุงุคู |
| Success Message | โ ููุท ุนูุฏ ุงููุฌุงุญ | โ ุฏุงุฆูุงู (ุญุชู ูู count=0) |
| Clear Selection | โ ููุท ุนูุฏ ุงููุฌุงุญ | โ ุฏุงุฆูุงู |

---

## 6๏ธโฃ ุงูุญู ุงูููุชุฑุญ (ูููุฑุงุฌุนุฉ ููุท)

### ุงูุญู 1: ุงุณุชุฎุฏุงู `bulkDelete()` ุจุฏูุงู ูู `bulkAction()` ููุญุฐู

**ุชุนุฏูู Blade:**
```blade
<option value="delete">ุญุฐู ููุงุฆู</option>
<!-- ุนูุฏ ุงุฎุชูุงุฑ deleteุ ุงุณุชุฏุนู bulkDelete() ูุจุงุดุฑุฉ ุจุฏูุงู ูู bulkAction() -->
```

**ุฃู ุชุนุฏูู `bulkAction()` ูุฅุถุงูุฉ Policy check:**
```php
match($this->bulkActionValue) {
    'delete' => $count = $this->performBulkDelete(),
    // ...
};

protected function performBulkDelete()
{
    $selectedIds = $this->selected;
    $deletableIds = [];

    Document::whereIn('id', $selectedIds)
        ->chunk(500, function ($documents) use (&$deletableIds) {
            foreach ($documents as $document) {
                if (auth()->user()->can('delete', $document)) {
                    $deletableIds[] = $document->id;
                }
            }
        });
    
    if (empty($deletableIds)) {
        $this->dispatch('show-toast', 
            message: 'ุบูุฑ ูุตุฑูุญ ููุฐู ุงูุนูููุฉ',
            type: 'error'
        );
        return 0;
    }
    
    return Document::whereIn('id', $deletableIds)->delete();
}
```

### ุงูุญู 2: ุฅุตูุงุญ Error Handling ูู `bulkAction()`

```php
} catch (\Exception $e) {
    \Log::error('Bulk delete failed: ' . $e->getMessage());
    $this->dispatch('show-toast', 
        message: 'ูุดูุช ุงูุนูููุฉ: ' . $e->getMessage(),
        type: 'error'
    );
    $this->bulkLoading = false;
    return;  // โ ูุง ุชุณุชูุฑ ุฅุฐุง ูุดูุช
}

// ููุท ุฅุฐุง ูุฌุญุช ุงูุนูููุฉ
if ($count > 0) {
    $this->clearSelection();
    $this->dispatch('show-toast', 
        message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
        type: 'success'
    );
} else {
    $this->dispatch('show-toast', 
        message: 'ูู ูุชู ุญุฐู ุฃู ูุซุงุฆู - ูุฏ ูุง ุชููู ุตูุงุญูุฉ ุงูุญุฐู',
        type: 'warning'
    );
}
```

---

## ๐ ุงูููุฎุต ุงูุชูููุฐู

**ุงููุดููุฉ:** ุงูุญุฐู ุงูุฌูุงุนู ูุง ูุนูู ูุฃู `bulkAction()` ูุง ุชุชุญูู ูู Policyุ ูุชุฎูู ุงูุฃุฎุทุงุก ุจุฏูู ุฑุณุงุฆู ูุงุถุญุฉ.

**ุงูุญู:** ุฅุถุงูุฉ Policy check ูุจู ุงูุญุฐูุ ูุฅุตูุงุญ Error Handling ูุฅุธูุงุฑ ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู.

---

**ุชู ุงูุชุดุฎูุต ุจุฏูู ุฃู ุชุนุฏููุงุช ุนูู ุงูููุฏ โ**


