# ๐ ุชูุฑูุฑ ุงูุชุดุฎูุต ุงูุฏููู - ูุดููุฉ ุงูุญุฐู

## 1๏ธโฃ ุงูููุฏ ุงููุงูู ููู Methods (ููุง ูู ุงูุขู)

---

### Method 1: `bulkAction()`

**ุงูููู:** `app/Livewire/Documents/DocumentTable.php` - ุงูุณุทูุฑ 424-479

```php
public function bulkAction()
{
    $this->bulkLoading = true;

    // โ ูุญุต ูุจูุฑ: ุงูุญุฐู ุงูุฌูุงุนู ูุญุฌูุฒ ููุท ููู admin
    if ($this->bulkActionValue === 'delete' && auth()->user()->role !== 'admin') {
        $this->bulkLoading = false;

        $this->dispatch('show-toast',
            message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
            type: 'error'
        );

        return;
    }

    if (empty($this->selected)) {
        $this->bulkLoading = false;
        $this->dispatch('show-toast', 
            message: 'ูู ูุชู ุชุญุฏูุฏ ุฃู ูุซุงุฆู',
            type: 'error'
        );
        return;
    }

    $validated = $this->validate([
        'bulkActionValue' => 'required|in:archive,delete,stage:draft,stage:review1,stage:proofread,stage:finalapproval'
    ]);

    $documentsQuery = Document::visibleTo(auth()->user())
        ->whereIn('id', $this->selected);

    $count = 0;
    $errors = 0;

    try {
        match($this->bulkActionValue) {
            'archive' => $count = $documentsQuery->update(['is_archived' => true]),
            'delete' => $count = $documentsQuery->delete(),
            'stage:draft' => $count = $documentsQuery->update(['current_stage' => 'draft']),
            'stage:review1' => $count = $documentsQuery->update(['current_stage' => 'review1']),
            'stage:proofread' => $count = $documentsQuery->update(['current_stage' => 'proofread']),
            'stage:finalapproval' => $count = $documentsQuery->update(['current_stage' => 'finalapproval']),
        };
    } catch (\Exception $e) {
        $errors = 1;
        $count = 0;
    }

    $this->bulkActionValue = '';
    $this->clearSelection();
    $this->resetPage();
    $this->bulkLoading = false;

    $this->dispatch('show-toast', 
        message: "ุชูุช ุงูุนูููุฉ ุนูู {$count} ูุซููุฉ ุจูุฌุงุญ",
        type: 'success'
    );
}
```

---

### Method 2: `bulkDelete()`

**ุงูููู:** `app/Livewire/Documents/DocumentTable.php` - ุงูุณุทูุฑ 553-589

```php
public function bulkDelete()
{
    // โ ูุญุต ูุจูุฑ: ุงูุญุฐู ุงูุฌูุงุนู ูุญุฌูุฒ ููุท ููู admin
    if (auth()->user()->role !== 'admin') {
        $this->dispatch('show-toast',
            message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
            type: 'error'
        );

        return;
    }

    // โ P1-8: Policy check ูุน chunking ููุฃุฏุงุก
    $selectedIds = $this->selected;
    $deletableIds = [];

    Document::whereIn('id', $selectedIds)
        ->chunk(500, function ($documents) use (&$deletableIds) {
            foreach ($documents as $document) {
                if (auth()->user()->can('delete', $document)) {
                    $deletableIds[] = $document->id;
                }
            }
        });
    
    if (empty($deletableIds)) {
        $this->dispatch('show-toast', 
            message: 'ุบูุฑ ูุตุฑูุญ ููุฐู ุงูุนูููุฉ',
            type: 'error'
        );
        return;
    }
    
    $count = count($deletableIds);
    Document::whereIn('id', $deletableIds)->delete();
    $this->selected = [];
    $this->showBulkActions = false;
    $this->dispatch('show-toast', message: "ุชู ุญุฐู {$count} ูุณุชูุฏ ุจูุฌุงุญ", type: 'success');
}
```

---

### Method 3: `deleteDocument($id)`

**ุงูููู:** `app/Livewire/Documents/DocumentTable.php` - ุงูุณุทูุฑ 670-679

```php
public function deleteDocument($id)
{
    $document = Document::findOrFail($id);
    $this->authorize('delete', $document);

    $document->delete();

    session()->flash('message', 'ุชู ุญุฐู ุงููุซููุฉ ุจูุฌุงุญ');
    $this->clearSelection();
}
```

---

### Method 4: `DocumentPolicy::delete()`

**ุงูููู:** `app/Policies/DocumentPolicy.php` - ุงูุณุทูุฑ 42-45

```php
public function delete(User $user, Document $document): bool
{
    return $user->role === 'admin';
}
```

---

## 2๏ธโฃ ุชุญููู ููุงุถุน ุงูุฃููุงุฏ ุงูุญุงุณูุฉ

### โ ููุถุน ุงูุญุงุฑุณ ูู `bulkAction()`:

**ุงููููุน:** ุงูุณุทุฑ 429

**ุงูููุถุน ุจุงููุณุจุฉ ููุนูููุงุช:**
```php
public function bulkAction()
{
    $this->bulkLoading = true;                    // ุงูุณุทุฑ 426
    
    // โ ุงูุญุงุฑุณ ููุง (ุงูุณุทุฑ 429)
    if ($this->bulkActionValue === 'delete' && auth()->user()->role !== 'admin') {
        // ...
        return;
    }

    if (empty($this->selected)) {                 // ุงูุณุทุฑ 440
        // ...
    }

    $validated = $this->validate([...]);          // ุงูุณุทุฑ 449
    // ...
}
```

**ุงูุชุญููู:**
- โ ุงูุญุงุฑุณ ููุฌูุฏ **ูุจู** `validate()`
- โ๏ธ **ุงููุดููุฉ:** ุงูุญุงุฑุณ ูุนุชูุฏ ุนูู `$this->bulkActionValue` ุงูุฐู ูุฏ ูููู ุบูุฑ ูุญุฏุฏ ุจุนุฏ ุฅุฐุง ุชู ุงุณุชุฏุนุงุก method ุจุดูู ูุจุงุดุฑ ุจุฏูู ุงุฎุชูุงุฑ ูู ุงููุงุฆูุฉ
- โ ููู ูู ุงููุถุน ุงูุทุจูุนู (ูู Blade template)ุ `wire:model.live="bulkActionValue"` ูุถูู ุฃู ุงููููุฉ ููุฌูุฏุฉ

---

### โ ููุทู case 'delete' ูู `bulkAction()`:

**ุงูููุฏ:** ุงูุณุทุฑ 462
```php
'delete' => $count = $documentsQuery->delete(),
```

**ุงูุชุญููู:**
- โ **ูุง ูุณุชุฎุฏู `chunk()` + `can('delete')`**
- โ **ูุณุชุฎุฏู `->delete()` ูุจุงุดุฑุฉ ุนูู Query**
- โ๏ธ **bypass Policy:** ูุง ูุชุญูู ูู Policy ููู ูุซููุฉ ุจุดูู ูุฑุฏู
- โ ููู: ุงูุญุงุฑุณ ูู ุงูุณุทุฑ 429 ูุถูู ุฃู ููุท admin ูุตู ุฅูู ููุง

**ุงูููุฏ ุงููุงูู:**
```php
$documentsQuery = Document::visibleTo(auth()->user())
    ->whereIn('id', $this->selected);

match($this->bulkActionValue) {
    'delete' => $count = $documentsQuery->delete(),  // โ ูุจุงุดุฑ ุจุฏูู Policy check
};
```

---

### โ ููุถุน ุงูุญุงุฑุณ ูู `bulkDelete()`:

**ุงููููุน:** ุงูุณุทุฑ 556 (ุฃูู ุณุทุฑ ูู method ุจุนุฏ ุงูุชุนููู)

**ุงูุชุญููู:**
- โ ุงูุญุงุฑุณ ูู **ุฃูู ุณุทุฑ** ูุจู ุฃู `chunk()` ุฃู ุนูููุงุช ุฃุฎุฑู
- โ ูููุน ุงูุชูููุฐ ูุจุงุดุฑุฉ ุฅุฐุง ูู ููู admin
- โ ุจุนุฏ ุงูุญุงุฑุณุ ุงูููุฏ ูุณุชุฎุฏู `chunk()` + `can('delete')` ููุชุญูู ูู Policy ููู ูุซููุฉ

---

### โ ูุฌูุฏ try/catch ูู `deleteDocument()`:

**ุงูููุฏ:** ุงูุณุทูุฑ 672-673
```php
$document = Document::findOrFail($id);
$this->authorize('delete', $document);
```

**ุงูุชุญููู:**
- โ **ูุง ููุฌุฏ `try/catch` ุญูู `authorize()`**
- โ๏ธ ุฅุฐุง ูุดู `authorize()` (ุงููุณุชุฎุฏู ููุณ admin)ุ Laravel ุณูุฑูู `AuthorizationException`
- โ๏ธ Laravel ุณูุนุฑุถ ุตูุญุฉ 403 ุงูุชุฑุงุถูุฉ (ููุณุช toast message)
- โ ููู ูู ุงููุถุน ุงูุทุจูุนูุ Policy ุณุชููุน ุบูุฑ admin ูู ุงูุญุฐู

---

## 3๏ธโฃ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ (ุจูุงุกู ุนูู ุงูููุฏ)

### ADMIN (role='admin'):

#### โ bulkAction('delete'):
```php
// ุงูุณุทุฑ 429: ุงูุดุฑุท false (admin === admin)
if ($this->bulkActionValue === 'delete' && auth()->user()->role !== 'admin') {
    // โ ูุง ูุชู ุงูุชูููุฐ
}

// ุงูุณุทุฑ 462: ูุชู ุงูุชูููุฐ
'delete' => $count = $documentsQuery->delete(),

// ุงููุชูุฌุฉ: โ ูุญุฐู ุฌููุน ุงููุซุงุฆู ุงููุญุฏุฏุฉ
```

**ุงููุชูุฌุฉ:** โ **ูุญุฐู**

---

#### โ bulkDelete():
```php
// ุงูุณุทุฑ 556: ุงูุดุฑุท false (admin !== admin)
if (auth()->user()->role !== 'admin') {
    // โ ูุง ูุชู ุงูุชูููุฐ
}

// ุงูุณุทุฑ 570-576: chunk + Policy check
// ุงูุณุทุฑ 585: delete()
// ุงููุชูุฌุฉ: โ ูุญุฐู ุงููุซุงุฆู ุงููุณููุญ ุจูุง
```

**ุงููุชูุฌุฉ:** โ **ูุญุฐู**

---

#### โ deleteDocument($id):
```php
// ุงูุณุทุฑ 673: authorize() ููุฌุญ (admin)
$this->authorize('delete', $document);  // โ true

// ุงูุณุทุฑ 675: delete()
$document->delete();

// ุงููุชูุฌุฉ: โ ูุญุฐู ุงููุซููุฉ
```

**ุงููุชูุฌุฉ:** โ **ูุญุฐู**

---

### LAWYER (role='lawyer'):

#### โ bulkAction('delete'):
```php
// ุงูุณุทุฑ 429: ุงูุดุฑุท true (lawyer !== admin)
if ($this->bulkActionValue === 'delete' && auth()->user()->role !== 'admin') {
    $this->bulkLoading = false;
    $this->dispatch('show-toast',
        message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
        type: 'error'
    );
    return;  // โ ูุชู ุงูููุน ููุง
}

// ุงูุณุทุฑ 462: โ ูุง ูุตู ุฅูู ููุง
```

**ุงููุชูุฌุฉ:** โ **Toast ุฎุทุฃ** - "ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท."

---

#### โ bulkDelete():
```php
// ุงูุณุทุฑ 556: ุงูุดุฑุท true (lawyer !== admin)
if (auth()->user()->role !== 'admin') {
    $this->dispatch('show-toast',
        message: 'ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท.',
        type: 'error'
    );
    return;  // โ ูุชู ุงูููุน ููุง
}

// ุงูุณุทุฑ 570: โ ูุง ูุตู ุฅูู ููุง
```

**ุงููุชูุฌุฉ:** โ **Toast ุฎุทุฃ** - "ุบูุฑ ูุตุฑุญ ูู ุจุญุฐู ุงููุซุงุฆู. ุงูุญุฐู ูุชุงุญ ูููุฏูุฑ ููุท."

---

#### โ deleteDocument($id):
```php
// ุงูุณุทุฑ 673: authorize() ููุดู (lawyer !== admin)
$this->authorize('delete', $document);  
// โ Laravel ูุฑูู AuthorizationException

// Laravel ูุนุฑุถ ุตูุญุฉ 403 ุงูุชุฑุงุถูุฉ
// โ ูุง toast message
```

**ุงููุชูุฌุฉ:** โ **ุตูุญุฉ 403** (AuthorizationException) - **ูุง toast message**

---

## 4๏ธโฃ ุงูุณุจุจ ุงูุฌุฐุฑู ูููุดููุฉ

### ๐จ ุงููุดููุฉ ุงูุฑุฆูุณูุฉ:

**`bulkAction('delete')` ูุณุชุฎุฏู `->delete()` ูุจุงุดุฑุฉ ุจุฏูู Policy check ูุฑุฏูุ ูููู ุงูุญุงุฑุณ ูููุน ุบูุฑ admin ูู ุงููุตูู ุฅูู ููุง.**

**ุงูุชุญููู ุงูุชูุตููู:**

#### 1. ููุถุน ุงูุญุงุฑุณ ูู `bulkAction()`:
- โ **ุงูููุถุน ุตุญูุญ** - ูู ุงูุณุทุฑ 429ุ ูุจู `validate()` ู `match()`
- โ **ูุนูู ุจุดูู ุตุญูุญ** - ูููุน ุบูุฑ admin ูู ุงูุญุฐู

#### 2. ููุทู case 'delete' ูู `bulkAction()`:
- โ๏ธ **ุงููุดููุฉ:** ูุณุชุฎุฏู `$documentsQuery->delete()` ูุจุงุดุฑุฉ ุจุฏูู `chunk()` + Policy check
- โ **ููู:** ุงูุญุงุฑุณ ูู ุงูุณุทุฑ 429 ูุถูู ุฃู ููุท admin ูุตู ุฅูู ููุง
- โ **ูุฐูู:** ุงููุดููุฉ ููุณุช ูู bypass Policyุ ุจู ูู ุนุฏู ุงูุชุญูู ูู Policy ููู ูุซููุฉ (ููู ูุฐุง ููุณ ูุดููุฉ ูุฃู ููุท admin ูุตู ููุง)

#### 3. `bulkDelete()`:
- โ **ููุถุน ุงูุญุงุฑุณ ุตุญูุญ** - ุฃูู ุณุทุฑ ูุจู `chunk()`
- โ **ุงูููุทู ุตุญูุญ** - ูุณุชุฎุฏู `chunk()` + Policy check ุจุนุฏ ุงูุญุงุฑุณ

#### 4. `deleteDocument()`:
- โ๏ธ **ูุง ููุฌุฏ try/catch ุญูู `authorize()`**
- โ **ุงููุดููุฉ:** ุนูุฏ ูุดู `authorize()` (ุบูุฑ admin)ุ Laravel ูุนุฑุถ ุตูุญุฉ 403 ุงูุชุฑุงุถูุฉ ุจุฏูุงู ูู toast message
- โ **ููู:** Policy ุชููุน ุบูุฑ admin ุจุดูู ุตุญูุญ

---

### ๐ ุงูุงุณุชูุชุงุฌ ุงูููุงุฆู:

**ุงูุณุจุจ ุงูุฌุฐุฑู ุงููุญูุฏ ูููุดููุฉ:**

1. โ **`bulkAction('delete')` ู `bulkDelete()` ูุนููุงู ุจุดูู ุตุญูุญ** - ุงูุญุงุฑุณ ูููุน ุบูุฑ adminุ ูadmin ูุญุฐู ุจูุฌุงุญ

2. โ๏ธ **`deleteDocument()` ูุนูู ุจุดูู ุตุญูุญ (Policy ุชููุน)ุ ููู:**
   - ุนูุฏ ูุดู `authorize()` (ุบูุฑ admin)ุ Laravel ูุนุฑุถ ุตูุญุฉ 403 ุจุฏูุงู ูู toast message
   - **ุงูุญู:** ุฅุถุงูุฉ `try/catch` ุญูู `authorize()` ูุฅุธูุงุฑ toast message ุจุฏูุงู ูู 403 page

3. โ๏ธ **`bulkAction('delete')` ูุณุชุฎุฏู `->delete()` ูุจุงุดุฑุฉ ุจุฏูู Policy check ูุฑุฏู:**
   - ูุฐุง ููุณ ูุดููุฉ ูุฃู ุงูุญุงุฑุณ ูุถูู ุฃู ููุท admin ูุตู ุฅูู ููุง
   - ููู ูููู ุชุญุณูู ุงูููุฏ ูุงุณุชุฎุฏุงู ููุณ ููุทู `bulkDelete()` (chunk + Policy check) ููุงุชุณุงู

---

## 5๏ธโฃ ุงูุฎูุงุตุฉ

### ุงููุชุงุฆุฌ:

| Method | ADMIN | LAWYER |
|--------|-------|--------|
| `bulkAction('delete')` | โ ูุญุฐู | โ Toast ุฎุทุฃ |
| `bulkDelete()` | โ ูุญุฐู | โ Toast ุฎุทุฃ |
| `deleteDocument($id)` | โ ูุญุฐู | โ ุตูุญุฉ 403 (ูุง toast) |

### ุงููุดููุฉ ุงููุญูุฏุฉ:

**`deleteDocument()` ูุนุฑุถ ุตูุญุฉ 403 ุจุฏูุงู ูู toast message ุนูุฏ ูุญุงููุฉ ุบูุฑ admin ููุญุฐู.**

**ุงูุญู:** ุฅุถุงูุฉ try/catch ุญูู `authorize()` ูุฅุธูุงุฑ toast message.

---

**ุชู ุงูุชุดุฎูุต ุจุฏูู ุฃู ุชุนุฏููุงุช โ**


